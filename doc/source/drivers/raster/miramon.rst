.. _raster.miramon:

MiraMon Raster
==============

.. versionadded:: 3.12

.. shortname:: MiraMonRaster

.. built_in_by_default::

This driver is capable of translating (reading and writing) raster files from MiraMon raster format.

Symbolization is neither read nor generated by this driver.

A `look-up-table of MiraMon <https://www.miramon.cat/help/eng/mm32/AP6.htm>`__ and
`EPSG <https://epsg.org/home.html>`__ Spatial Reference Systems allows matching
identifiers in both systems.

If a layer contains an old *.rel* format file (used some decades ago),
a warning message will appear explaining how to convert it into a modern *.rel 4* file.

Driver capabilities
-------------------

.. supports_create::

.. supports_georeferencing::

.. supports_virtualio::

Overview of MiraMon format
--------------------------

The MiraMon .img format is a binary format for raster data with rich metadata.
More information about the MiraMon raster format is available `on the public
specification <https://www.miramon.cat/new_note/eng/notes/MiraMon_structured_raster_file_format.pdf>`__.

By providing only the main file name, the driver will automatically use the sidecar metadata file. 
In the creation of MiraMon layers, you only need to provide the name
of the main file (with or without extension), and the driver will create the metadata file.

The following outlines the information contained within each sidecar file:

These are the maim characteristics of MiraMon rasters dataset:

- **img file**: This is the main file containing only the data. The data can be of various types:

    - *Byte*: 1 byte numbers. Range: 0 to 255
    - *Short*: 2 bytes signed short integer numbers. Range: -32,768 to 32,767
    - *UShort*: 2 bytes unsigned short integer numbers. Range: 0 to 65,535
    - *Int32*: 4 bytes signed integer numbers. Range: -2,147,483,648 to 2,147,483,647
    - *UInt32*: 4 bytes unsigned integer numbers. Range: 0 to 4,294,967,295
    - *Int64*: 8 bytes signed integer numbers.
    - *UInt64*: 8 bytes unsigned integer numbers.
    - *Real*: 4 bytes real numbers.
    - *Double*: 8 bytes real numbers.


Encoding
--------

When reading MiraMon files the code page setting in the header of the .dbf file
is read and used to translate string fields to UTF-8 (regardless of whether they
are in ANSI, OEM or UTF-8).

When writing MiraMon files the codepage of *.dbf* files can be ANSI or UTF8
depending on the layer creation option DBFEncoding.

Creation Issues
---------------

MiraMon can only store one kind of geometry per layer
(points, arcs or polygons). Mixing different kinds of layers
(including raster and geoservices as WMS or WMTS) is possible through MiraMon maps (.mmm).
During creation the driver generates the necessary files to
accommodate each of the three possible types of geometries.
For instance, if a layer or a dataset contains points and arcs,
a set of point files and a set of arc files will be created.

Consequently, during creation the MiraMon vector driver output can be a
folder or a set of files with the appropriate extension (*.pnt*, etc):

- If the output is a **folder**, it will contain all the translated layers with the original name in the origin dataset.

  - In this case a *.mmm* file will be created referencing all layers in the origin dataset to make an
    easy open of the dataset using the MiraMon software.
  - In this case, please specify the MiraMon file output format name using the -f option (**-f MiraMonVector**).

- If the output is a **file** with extension all the translated layers in the origin dataset will be created with the specified name.
  Use this option only when you know that there is only one layer with one feature type in the origin dataset.

The attributes of the MiraMon feature are stored in an associated *.dbf*.
If a classical DBF IV table could not be used (too many fields or records,
large text fields, etc) a file type called extended DBF is used.
This is an improvement of dBASE IV DBF files. The specification of this format can be found in `this file
<https://www.miramon.cat/new_note/eng/notes/DBF_estesa.pdf>`__.

Note that extended *.dbf* files cannot be opened with Excel or
other typical programs. If the complete MiraMon Professional software
is not installed on the computer, the free and standalone
MiraD application can be downloaded from
`this page <https://www.miramon.cat/USA/Prod-MiraD.htm>`__ to open them.

Connection string
-----------------

The MiraMon driver accepts three types of sources of data:

When translating from a MiraMon vector format, the MiraMon vector driver input needs a file with one of the
described extensions:

-  *.pnt* for *points*.
-  *.arc* for *linestrings*.
-  *.pol* for *polygons* (or *multipolygons*).

The extension *.nod* is not valid for translation. Take in consideration all auxiliary files described above.

Field sizes
-----------

The driver will automatically extend string and integer fields to
dynamically accommodate the length of the data to be inserted.

Size Issues
-----------

Geometry: The MiraMon vector format explicitly uses 32-bit offsets in the 1.1 version
and 64-bit offsets in the 2.0 version. It is better to produce 1.1 version files if 2.0
version is not really necessary than always use 2.0 version. Version 1.x files are smaller.

Attributes: The dbf format does not have any offsets in it, so it can be
arbitrarily large.

Open options
------------

The following open options are available.

-  .. oo:: Height
      :choices: First, Lowest, Highest

      Sets which of the possible heights for each vertex is read:
      the *first*, the *lowest* or the *highest* one. It only applies to
      MiraMon multi-height layers, where the same X,Y vertex can have more than one Z.

-  .. oo:: MultiRecordIndex
      :choices: 1, 2, ..., Last, JSON

      In case of fields of type List, if the output driver cannot support them,
      user can select which one wants to keep: *MultiRecordIndex=1* for first, *MultiRecordIndex=2* for second, etc
      and *MultiRecordIndex=last* for the last element of the list.
      *MultiRecordIndex=JSON* option converts the list in a single value in JSON format.
      If not specified, all elements of the list will be translated by default as a OGR list field type.

-  .. oo:: OpenLanguage
      :choices: ENG, CAT, SPA
      :default: ENG

      If the layer to be opened is multilingual (in fact, the *.rel* file), this
      parameter sets the language to be read.


Dataset creation options
------------------------

None

Layer creation options
----------------------

-  .. lco:: Version
      :choices: V1.1, V2.0, last_version
      :default: V1.1

      Version of the file.
      Version 1.1 is limited to an unsigned 32-bit integer for FID, for internal
      offsets and for the number of entities the layer can handle.
      It is the default option.
      Version 2.0 is the 64-bit version. It is practically unlimited
      (unsigned 64-bit integer for FID and internal offsets).
      last_version selects to the last existing version ever.

-  .. lco:: DBFEncoding
      :choices: UTF8, ANSI
      :default: ANSI

      Encoding of the *.dbf* files.
      The MiraMon vector driver can write *.dbf* files in UTF-8 or ANSI charsets.

      As at the moment of this release, UTF-8 tables are not editable in the
      `MiraD application <https://www.miramon.cat/USA/Prod-MiraD.htm>`__, so it
      is recommended to use ANSI instead, if there are no coding problems.

-  .. oo:: CreationLanguage
      :choices: ENG, CAT, SPA
      :default: ENG

      Sets the language used in the metadata file (*.rel*) for the descriptors of
      the *.dbf* fields.

Examples
--------

-  A translation from an *Example_1.dxf* file with one layer but some different geometric types
   in the layer, will result 'file1.dxf' into a new MiraMon set of layers in the 'output_folder'.

   ::

      ogr2ogr output_folder Example_1.dxf -f MiraMonVector -lco Version=V1.1


-  A translation from a *Example_2.dxf* file with one polygon type layer 'file1.dxf' into a new MiraMon layer
   'territories.pol' (with UTF-8 encoding at the *.dbf* files) is performed like this:

   ::

      ogr2ogr territories.pol Example_2.dxf -lco DBFEncoding=UTF8 (no needed to include **-f MiraMonVector** because the output layer is not a directory)


-  A translation from a MiraMon layer of arcs, 'rivers.arc', into a new *.gml* file (taking only the first element of
   the multirecords in the attributes table) is performed like this:

   ::

      ogr2ogr rivers.gml rivers.arc -oo MultiRecordIndex=1

-  A translation from a MiraMon layer 'tracks.arc' into a new *.gml* file taking the first height of
   every point is performed like this:

   ::

      ogr2ogr tracks.gml tracks.arc -oo Height=First

-  A translation from a MiraMon layer 'tracks.arc' into a new *.gml* file taking the last height of
   every point and documenting the attribute descriptors in Catalan (if the layer is multilingual
   and it has this language available) is performed like this:

   ::

      ogr2ogr tracks.gml tracks.arc -oo Height=First -oo Language=CAT


See Also
--------

-  `MiraMon's vector format specifications <https://www.miramon.cat/new_note/eng/notes/MiraMon_structured_vectors_file_format.pdf>`__
-  `MiraMon Extended DBF format <https://www.miramon.cat/new_note/eng/notes/DBF_estesa.pdf>`__
-  `MiraMon vector layer concepts <https://www.miramon.cat/help/eng/mm32/ap2.htm#structured_vector>`__.
-  `MiraMon page <https://www.miramon.cat/Index_usa.htm>`__
-  `MiraMon help guide <https://www.miramon.cat/help/eng>`__
-  `Grumets research group, the people behind MiraMon <https://www.grumets.cat/index_eng.htm>`__
